{% extends 'base.html' %}
{% load photo_filters %}

{% block title %}
<title>{{ lab_name }} Photos</title>
<meta name="description" content="{{ general_data.about|default:'Lab Photos' }}">
{% endblock title %}

{% block content %}
<section id="photos" class="container-xl">
  <h1 class="text-center display-4">{{ lab_name }} Photos</h1>
  
  {% if photo_data.data %}
    <div id="labPhotosCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="3000">
      <!-- Indicators -->
      <div class="carousel-indicators">
        {% for post in photo_data.data %}
          {% if post.full_picture %}
            <button type="button" data-bs-target="#labPhotosCarousel" data-bs-slide-to="{{ forloop.counter0 }}"
                    {% if forloop.first %}class="active" aria-current="true"{% endif %}
                    aria-label="Slide {{ forloop.counter }}"></button>
          {% endif %}
        {% endfor %}
      </div>

      <!-- Slides -->
      <div class="carousel-inner">
        {% for post in photo_data.data %}
          {% if post.full_picture %}
            <div class="carousel-item {% if forloop.first %}active{% endif %}">
              <div class="row justify-content-center">
                <div class="col-lg-8 col-md-10">
                  <div class="card">
                    {% if post.message %}
                      <div class="card-body">
                        <p class="card-text text-center">{{ post.message }}</p>
                      </div>
                    {% endif %}
                    <img src="{{ post.full_picture }}"
                         class="card-img-top"
                         alt="{{ post.message|default:'Lab photo' }}"
                         width="800" height="400"
                         onerror="this.src='https://picsum.photos/800/400?random=' + {{ forloop.counter }}">
                  </div>
                </div>
              </div>
            </div>
          {% endif %}
        {% empty %}
          <div class="carousel-item active">
            <div class="row justify-content-center">
              <div class="col-lg-8 col-md-10">
                <div class="card">
                  <div class="card-body">
                    <p class="card-text text-center">No photos available.</p>
                  </div>
                  <img src="https://picsum.photos/800/400?random=0" class="card-img-top" alt="No Photos" width="800" height="400">
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- Controls -->
      <button class="carousel-control-prev" type="button" data-bs-target="#labPhotosCarousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Previous</span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#labPhotosCarousel" data-bs-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Next</span>
      </button>
    </div>
  {% else %}
    <p class="text-center">No photos available.</p>
  {% endif %}

  <!-- Debug Carousel Items -->
  <div class="mt-3 text-center">
    <p><strong>Carousel items rendered: {{ photo_data.data|filter:"full_picture"|length }}</strong></p>
  </div>
</section>

<style>
  .carousel, .carousel-inner, .carousel-item, .carousel-item img {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    width: 100% !important;
  }
  .carousel-item {
    position: relative !important;
    min-height: 400px !important;
    background: #f0f0f0 !important;
  }
  .carousel-item img {
    max-height: 400px !important;
    height: 400px !important;
    width: 100% !important;
    object-fit: cover !important;
  }
  .card {
    border: none !important;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1) !important;
  }
  .card-body {
    background: rgba(0, 0, 0, 0.6) !important;
    color: #fff !important;
    border-radius: 5px !important;
    padding: 10px !important;
  }
  .carousel-indicators {
    z-index: 1 !important;
  }
  .carousel-indicators [data-bs-target] {
    background-color: #005B5F !important; /* Dark teal for indicators */
  }
  .carousel-control-prev, .carousel-control-next {
    width: 5% !important;
    background: rgba(0, 91, 95, 0.5) !important; /* Semi-transparent dark teal */
    border-radius: 5px !important;
    transition: background 0.3s ease !important;
  }
  .carousel-control-prev:hover, .carousel-control-next:hover {
    background: rgba(0, 91, 95, 0.8) !important; /* Darker on hover */
  }
  .carousel-control-prev-icon, .carousel-control-next-icon {
    background-image: none !important;
    width: 30px !important;
    height: 30px !important;
    position: relative !important;
  }
  .carousel-control-prev-icon::before, .carousel-control-next-icon::before {
    content: '' !important;
    display: block !important;
    width: 100% !important;
    height: 100% !important;
    background: #fff !important; /* White arrow for contrast */
    -webkit-mask-size: contain !important;
    mask-size: contain !important;
    position: absolute !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
  }
  .carousel-control-prev-icon::before {
    -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23000'%3E%3Cpath d='M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z'/%3E%3C/svg%3E") !important;
    mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23000'%3E%3Cpath d='M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z'/%3E%3C/svg%3E") !important;
  }
  .carousel-control-next-icon::before {
    -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23000'%3E%3Cpath d='M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E") !important;
    mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23000'%3E%3Cpath d='M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E") !important;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    console.log('DOM loaded, checking carousel...');
    const labCarousel = document.querySelector('#labPhotosCarousel');
    console.log('Lab Photos Carousel element:', !!labCarousel);
    if (labCarousel) {
      const items = labCarousel.querySelectorAll('.carousel-item');
      console.log('Lab Photos Carousel items:', items.length);
      if (items.length === 0) {
        console.log('No carousel items found in #labPhotosCarousel');
      } else {
        console.log('First carousel item active:', !!labCarousel.querySelector('.carousel-item.active'));
        console.log('Sample image sources:', Array.from(items).slice(0, 3).map(item => ({
          src: item.querySelector('img').src,
          fullPicture: item.querySelector('img').getAttribute('src')
        })));
      }
      try {
        const carouselInstance = bootstrap.Carousel.getOrCreateInstance(labCarousel, { interval: 3000, ride: 'carousel' });
        console.log('Bootstrap carousel initialized successfully');
        labCarousel.addEventListener('slide.bs.carousel', (e) => {
          console.log('Lab Carousel sliding to index:', e.to, 'from:', e.from);
        });
        labCarousel.addEventListener('slid.bs.carousel', (e) => {
          console.log('Lab Carousel slid to index:', e.to, 'from:', e.from);
        });
      } catch (error) {
        console.log('Carousel initialization error:', error.message);
      }
    } else {
      console.log('Lab Photos Carousel not found');
    }
    // Log image loading status
    const images = document.querySelectorAll('#labPhotosCarousel .carousel-item img');
    images.forEach((img, index) => {
      img.addEventListener('error', () => console.log(`Image ${index + 1} failed to load: ${img.src}`));
      img.addEventListener('load', () => console.log(`Image ${index + 1} loaded successfully: ${img.src}`));
    });
  });
</script>
{% endblock content %}